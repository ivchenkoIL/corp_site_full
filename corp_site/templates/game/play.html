<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Quiz!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: #fff;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
        }
        .q-counter {
            font-weight: 700;
            color: rgba(255,255,255,0.6);
        }
        .category-badge {
            background: rgba(255,111,216,0.2);
            border: 1px solid rgba(255,111,216,0.3);
            color: #ff6fd8;
            padding: 4px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .timer-container {
            text-align: center;
            margin: 10px 0 20px;
        }
        .timer-ring {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            position: relative;
        }
        .timer-ring svg { transform: rotate(-90deg); }
        .timer-ring circle {
            fill: none;
            stroke-width: 5;
        }
        .timer-ring .bg { stroke: rgba(255,255,255,0.1); }
        .timer-ring .fg {
            stroke: #2ed573;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s, stroke 0.3s;
        }
        .timer-ring .fg.warning { stroke: #ffa502; }
        .timer-ring .fg.danger { stroke: #ff4757; }
        .timer-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 1.6rem;
            font-weight: 800;
        }
        .question-text {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0 20px;
            margin-bottom: 24px;
            line-height: 1.4;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .option-btn {
            border: 2px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            color: #fff;
            border-radius: 16px;
            padding: 18px 14px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .option-btn:hover:not(.disabled) {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.3);
            transform: scale(1.02);
        }
        .option-btn.selected {
            border-color: #3742fa;
            background: rgba(55,66,250,0.25);
        }
        .option-btn.correct {
            border-color: #2ed573;
            background: rgba(46,213,115,0.25);
            animation: pop 0.4s;
        }
        .option-btn.wrong {
            border-color: #ff4757;
            background: rgba(255,71,87,0.2);
            opacity: 0.7;
        }
        .option-btn.disabled { pointer-events: none; }
        .option-label {
            position: absolute;
            top: 6px;
            left: 12px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.35);
            font-weight: 700;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Scoreboard */
        .scoreboard {
            margin-top: 24px;
            padding: 0 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-radius: 10px;
            margin-bottom: 4px;
            background: rgba(255,255,255,0.04);
        }
        .score-row:first-child { background: rgba(255,111,216,0.12); }
        .score-name { font-weight: 600; }
        .score-pts { font-weight: 800; color: #ff6fd8; }

        /* Reveal answer box */
        .reveal-box {
            text-align: center;
            margin-top: 16px;
            padding: 16px;
        }
        .reveal-result {
            font-size: 1.3rem;
            font-weight: 700;
        }
        .reveal-result.correct { color: #2ed573; }
        .reveal-result.wrong { color: #ff4757; }
        .reveal-points { color: #ffa502; font-weight: 800; font-size: 1.8rem; }

        .answered-badge {
            text-align: center;
            color: rgba(255,255,255,0.4);
            margin-top: 12px;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .question-text { font-size: 1.2rem; }
            .options-grid { grid-template-columns: 1fr; }
            .option-btn { padding: 16px 12px; }
        }
    </style>
</head>
<body>
    <div id="game-screen">
        <div class="top-bar">
            <span class="q-counter" id="q-counter">1 / 10</span>
            <span class="category-badge" id="category">...</span>
        </div>

        <div class="timer-container">
            <div class="timer-ring">
                <svg width="80" height="80" viewBox="0 0 80 80">
                    <circle class="bg" cx="40" cy="40" r="35"/>
                    <circle class="fg" id="timer-circle" cx="40" cy="40" r="35"
                            stroke-dasharray="220" stroke-dashoffset="0"/>
                </svg>
                <div class="timer-number" id="timer-num">15</div>
            </div>
        </div>

        <div class="question-text" id="question-text">Загрузка...</div>

        <div class="options-grid" id="options">
            <button class="option-btn" data-opt="a" onclick="submitAnswer('a')">
                <span class="option-label">A</span>
                <span class="option-text" id="opt-a">...</span>
            </button>
            <button class="option-btn" data-opt="b" onclick="submitAnswer('b')">
                <span class="option-label">B</span>
                <span class="option-text" id="opt-b">...</span>
            </button>
            <button class="option-btn" data-opt="c" onclick="submitAnswer('c')">
                <span class="option-label">C</span>
                <span class="option-text" id="opt-c">...</span>
            </button>
            <button class="option-btn" data-opt="d" onclick="submitAnswer('d')">
                <span class="option-label">D</span>
                <span class="option-text" id="opt-d">...</span>
            </button>
        </div>

        <div class="answered-badge" id="answered-badge"></div>

        <div class="reveal-box" id="reveal-box" style="display:none">
            <div class="reveal-result" id="reveal-result"></div>
            <div class="reveal-points" id="reveal-points"></div>
        </div>

        <div class="scoreboard" id="scoreboard"></div>
    </div>

    <script>
        const ROOM_CODE = '{{ room.code }}';
        const TOTAL_TIME = 15;
        let currentPhase = '';
        let myAnswerSent = false;
        let lastQuestionNum = -1;

        function getCookie(name) {
            let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }

        function updateTimer(timeLeft) {
            const circle = document.getElementById('timer-circle');
            const num = document.getElementById('timer-num');
            const t = Math.max(0, Math.ceil(timeLeft));
            num.textContent = t;
            const offset = 220 * (1 - timeLeft / TOTAL_TIME);
            circle.style.strokeDashoffset = offset;
            circle.classList.remove('warning', 'danger');
            if (t <= 3) circle.classList.add('danger');
            else if (t <= 7) circle.classList.add('warning');
        }

        function renderScoreboard(players) {
            const sb = document.getElementById('scoreboard');
            sb.innerHTML = players.map(p =>
                '<div class="score-row"><span class="score-name">' + p.name + '</span><span class="score-pts">' + p.score + '</span></div>'
            ).join('');
        }

        function setOptionsDisabled(disabled) {
            document.querySelectorAll('.option-btn').forEach(b => {
                if (disabled) b.classList.add('disabled');
                else b.classList.remove('disabled');
            });
        }

        function clearOptionStyles() {
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected', 'correct', 'wrong', 'disabled');
            });
        }

        async function submitAnswer(opt) {
            if (myAnswerSent) return;
            myAnswerSent = true;

            // Visual selection
            document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled'));
            document.querySelector('[data-opt="' + opt + '"]').classList.add('selected');

            try {
                const resp = await fetch('/game/api/answer/' + ROOM_CODE + '/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCookie('csrftoken')},
                    body: 'answer=' + opt
                });
                const data = await resp.json();
                if (data.error) {
                    console.log('Answer error:', data.error);
                }
            } catch(e) {
                console.error(e);
            }
        }

        async function pollGame() {
            try {
                const resp = await fetch('/game/api/state/' + ROOM_CODE + '/');
                const data = await resp.json();

                if (data.phase === 'finished') {
                    window.location.href = '/game/results/' + ROOM_CODE + '/';
                    return;
                }

                if (data.phase === 'question') {
                    // New question?
                    if (data.question_num !== lastQuestionNum) {
                        lastQuestionNum = data.question_num;
                        myAnswerSent = false;
                        clearOptionStyles();
                        document.getElementById('reveal-box').style.display = 'none';
                    }

                    document.getElementById('q-counter').textContent = data.question_num + ' / ' + data.total_questions;
                    document.getElementById('category').textContent = data.category;
                    document.getElementById('question-text').textContent = data.question;
                    document.getElementById('opt-a').textContent = data.options.a;
                    document.getElementById('opt-b').textContent = data.options.b;
                    document.getElementById('opt-c').textContent = data.options.c;
                    document.getElementById('opt-d').textContent = data.options.d;

                    updateTimer(data.time_left);
                    document.getElementById('answered-badge').textContent =
                        'Ответили: ' + data.answered_count + ' / ' + data.total_players;

                    if (data.my_answer) {
                        myAnswerSent = true;
                        setOptionsDisabled(true);
                        document.querySelector('[data-opt="' + data.my_answer + '"]').classList.add('selected');
                    } else {
                        setOptionsDisabled(false);
                    }

                    renderScoreboard(data.players);
                    currentPhase = 'question';
                }

                if (data.phase === 'reveal') {
                    setOptionsDisabled(true);
                    updateTimer(0);

                    document.getElementById('q-counter').textContent = data.question_num + ' / ' + data.total_questions;
                    document.getElementById('category').textContent = data.category;
                    document.getElementById('question-text').textContent = data.question;
                    document.getElementById('opt-a').textContent = data.options.a;
                    document.getElementById('opt-b').textContent = data.options.b;
                    document.getElementById('opt-c').textContent = data.options.c;
                    document.getElementById('opt-d').textContent = data.options.d;

                    // Highlight correct/wrong
                    document.querySelectorAll('.option-btn').forEach(b => {
                        const opt = b.dataset.opt;
                        b.classList.remove('selected');
                        if (opt === data.correct) {
                            b.classList.add('correct');
                        } else if (data.my_answer === opt) {
                            b.classList.add('wrong');
                        }
                    });

                    // Show result
                    const revealBox = document.getElementById('reveal-box');
                    const revealResult = document.getElementById('reveal-result');
                    const revealPoints = document.getElementById('reveal-points');
                    revealBox.style.display = 'block';

                    if (data.my_answer === data.correct) {
                        revealResult.className = 'reveal-result correct';
                        revealResult.textContent = 'Правильно!';
                        const myA = data.answers.find(a => a.answer === data.my_answer && a.is_correct);
                        if (myA) revealPoints.textContent = '+' + myA.points;
                        else revealPoints.textContent = '';
                    } else if (data.my_answer) {
                        revealResult.className = 'reveal-result wrong';
                        revealResult.textContent = 'Неправильно!';
                        revealPoints.textContent = '';
                    } else {
                        revealResult.className = 'reveal-result wrong';
                        revealResult.textContent = 'Время вышло!';
                        revealPoints.textContent = '';
                    }

                    document.getElementById('answered-badge').textContent = '';
                    renderScoreboard(data.players);
                    currentPhase = 'reveal';
                }

            } catch(e) {
                console.error(e);
            }
            setTimeout(pollGame, 1200);
        }

        pollGame();
    </script>
</body>
</html>
